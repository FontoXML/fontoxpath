"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
function createHashKey(namespaceURI, localName) {
    return `Q{${namespaceURI || ''}}${localName}`;
}
function lookupInOverrides(overrides, key) {
    key = key + '';
    for (let i = overrides.length - 1; i >= 0; --i) {
        if (key in overrides[i]) {
            return overrides[i][key];
        }
    }
    return undefined;
}
/**
 * The static context consists of all information that is available at compile time: the globally
 * defined functions, locally defined functions, etc.
 *
 * It will be overlayed by itself, but overlays the execution context, since that may know of
 * namespaces or variables that are also available in a global scope, but only when the selector uses
 * none.
 *
 * @implements {Context}
 */
class StaticContext {
    constructor(parentContext) {
        this.parentContext = parentContext;
        this._scopeDepth = 0;
        this._scopeCount = 0;
        this._registeredNamespaceURIByPrefix = [Object.create(null)];
        this._registeredVariableBindingByHashKey = [Object.create(null)];
        // Functions may never be added for only a closure
        this._registeredFunctionsByHash = Object.create(null);
    }
    registerFunctionDefinition(namespaceURI, localName, arity, functionDefinition) {
        const hashKey = createHashKey(namespaceURI, localName) + '~' + arity;
        const duplicateFunction = this._registeredFunctionsByHash[hashKey];
        if (duplicateFunction) {
            throw new Error('Duplicate function registration');
        }
        this._registeredFunctionsByHash[hashKey] = functionDefinition;
    }
    lookupFunction(namespaceURI, localName, arity) {
        const hashKey = createHashKey(namespaceURI, localName) + '~' + arity;
        const foundFunction = this._registeredFunctionsByHash[hashKey];
        if (foundFunction) {
            return foundFunction;
        }
        return this.parentContext === null ? null : this.parentContext.lookupFunction(namespaceURI, localName, arity);
    }
    /**
     * Register the _existence_ of a variable.
     *
     * We need this to separate variable declaration (which is required to be done statically) and
     * from when the dynamic context of the variable will be known.
     */
    registerVariable(namespaceURI, localName) {
        const hash = createHashKey(namespaceURI, localName);
        return this._registeredVariableBindingByHashKey[this._scopeDepth][hash] = `${hash}[${this._scopeCount}]`;
    }
    registerNamespace(prefix, namespaceURI) {
        this._registeredNamespaceURIByPrefix[this._scopeDepth][prefix] = namespaceURI;
    }
    lookupVariable(namespaceURI, localName) {
        const hash = createHashKey(namespaceURI, localName);
        const varNameInCurrentScope = lookupInOverrides(this._registeredVariableBindingByHashKey, hash);
        if (varNameInCurrentScope) {
            return varNameInCurrentScope;
        }
        return this.parentContext.lookupVariable(namespaceURI, localName);
    }
    introduceScope() {
        this._scopeCount++;
        this._scopeDepth++;
        this._registeredNamespaceURIByPrefix[this._scopeDepth] = Object.create(null);
        this._registeredVariableBindingByHashKey[this._scopeDepth] = Object.create(null);
    }
    removeScope() {
        this._registeredNamespaceURIByPrefix.length = this._scopeDepth;
        this._registeredVariableBindingByHashKey.length = this._scopeDepth;
        this._scopeDepth--;
    }
    resolveNamespace(prefix) {
        const uri = lookupInOverrides(this._registeredNamespaceURIByPrefix, prefix);
        if (uri === undefined) {
            return this.parentContext === null ? undefined : this.parentContext.resolveNamespace(prefix);
        }
        return uri;
    }
    /**
     * Make a clone of this static context at the current scope that can be retained for later usage
     * (such as dynamic namespace lookups)
     *
     * @return {StaticContext}
     */
    cloneContext() {
        const contextAtThisPoint = new StaticContext(this.parentContext);
        for (let i = 0; i < this._scopeDepth + 1; ++i) {
            contextAtThisPoint._registeredNamespaceURIByPrefix = [Object.assign(Object.create(null), contextAtThisPoint._registeredNamespaceURIByPrefix[0], this._registeredNamespaceURIByPrefix[i])];
            contextAtThisPoint._registeredVariableBindingByHashKey = [Object.assign(Object.create(null), contextAtThisPoint._registeredVariableBindingByHashKey[0], this._registeredVariableBindingByHashKey[i])];
        }
        return contextAtThisPoint;
    }
}
exports.default = StaticContext;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU3RhdGljQ29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlN0YXRpY0NvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxTQUFTLGFBQWEsQ0FBRSxZQUFZLEVBQUUsU0FBUztJQUM5QyxPQUFPLEtBQUssWUFBWSxJQUFJLEVBQUUsSUFBSSxTQUFTLEVBQUUsQ0FBQztBQUMvQyxDQUFDO0FBRUQsU0FBUyxpQkFBaUIsQ0FBRSxTQUFTLEVBQUUsR0FBRztJQUN6QyxHQUFHLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQztJQUNmLEtBQUssSUFBSSxDQUFDLEdBQUcsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsRUFBRTtRQUMvQyxJQUFJLEdBQUcsSUFBSSxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDeEIsT0FBTyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDekI7S0FDRDtJQUVELE9BQU8sU0FBUyxDQUFDO0FBQ2xCLENBQUM7QUFFRDs7Ozs7Ozs7O0dBU0c7QUFDSCxNQUFxQixhQUFhO0lBUWpDLFlBQWEsYUFBc0I7UUFDbEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7UUFFbkMsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFDckIsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFFckIsSUFBSSxDQUFDLCtCQUErQixHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxtQ0FBbUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUVqRSxrREFBa0Q7UUFDbEQsSUFBSSxDQUFDLDBCQUEwQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDdkQsQ0FB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QUFpQixDQUFDLElBQUksQ0FBQywrQkFBK0IsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM1RSxJQUFJLEdBQUcsS0FBSyxTQUFTLEVBQUU7WUFDdEIsT0FBTyxJQUFJLENBQUMsYUFBYSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQzdGO1FBQ0QsT0FBTyxHQUFHLENBQUM7SUFDWixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCxZQUFZO1FBQ1gsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDakUsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFO1lBQzlDLGtCQUFrQixDQUFDLCtCQUErQixHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FDbEUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFDbkIsa0JBQWtCLENBQUMsK0JBQStCLENBQUMsQ0FBQyxDQUFDLEVBQ3JELElBQUksQ0FBQywrQkFBK0IsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0Msa0JBQWtCLENBQUMsbUNBQW1DLEdBQUcsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUN0RSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUNuQixrQkFBa0IsQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDLENBQUMsRUFDekQsSUFBSSxDQUFDLG1DQUFtQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUMvQztRQUVELE9BQU8sa0JBQWtCLENBQUM7SUFDM0IsQ0FBQztDQUNEO0FBL0dELGdDQStHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDb250ZXh0IGZyb20gJy4vQ29udGV4dCc7XG5cbmZ1bmN0aW9uIGNyZWF0ZUhhc2hLZXkgKG5hbWVzcGFjZVVSSSwgbG9jYWxOYW1lKSB7XG5cdHJldHVybiBgUXske25hbWVzcGFjZVVSSSB8fCAnJ319JHtsb2NhbE5hbWV9YDtcbn1cblxuZnVuY3Rpb24gbG9va3VwSW5PdmVycmlkZXMgKG92ZXJyaWRlcywga2V5KSB7XG5cdGtleSA9IGtleSArICcnO1xuXHRmb3IgKGxldCBpID0gb3ZlcnJpZGVzLmxlbmd0aCAtIDE7IGkgPj0gMDsgLS1pKSB7XG5cdFx0aWYgKGtleSBpbiBvdmVycmlkZXNbaV0pIHtcblx0XHRcdHJldHVybiBvdmVycmlkZXNbaV1ba2V5XTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gdW5kZWZpbmVkO1xufVxuXG4vKipcbiAqIFRoZSBzdGF0aWMgY29udGV4dCBjb25zaXN0cyBvZiBhbGwgaW5mb3JtYXRpb24gdGhhdCBpcyBhdmFpbGFibGUgYXQgY29tcGlsZSB0aW1lOiB0aGUgZ2xvYmFsbHlcbiAqIGRlZmluZWQgZnVuY3Rpb25zLCBsb2NhbGx5IGRlZmluZWQgZnVuY3Rpb25zLCBldGMuXG4gKlxuICogSXQgd2lsbCBiZSBvdmVybGF5ZWQgYnkgaXRzZWxmLCBidXQgb3ZlcmxheXMgdGhlIGV4ZWN1dGlvbiBjb250ZXh0LCBzaW5jZSB0aGF0IG1heSBrbm93IG9mXG4gKiBuYW1lc3BhY2VzIG9yIHZhcmlhYmxlcyB0aGF0IGFyZSBhbHNvIGF2YWlsYWJsZSBpbiBhIGdsb2JhbCBzY29wZSwgYnV0IG9ubHkgd2hlbiB0aGUgc2VsZWN0b3IgdXNlc1xuICogbm9uZS5cbiAqXG4gKiBAaW1wbGVtZW50cyB7Q29udGV4dH1cbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgU3RhdGljQ29udGV4dCB7XG5cdHBhcmVudENvbnRleHQ6IENvbnRleHQ7XG5cdF9zY29wZURlcHRoOiBudW1iZXI7XG5cdF9zY29wZUNvdW50OiBudW1iZXI7XG5cdF9yZWdpc3RlcmVkTmFtZXNwYWNlVVJJQnlQcmVmaXg6IGFueVtdO1xuXHRfcmVnaXN0ZXJlZFZhcmlhYmxlQmluZGluZ0J5SGFzaEtleTogYW55W107XG5cdF9yZWdpc3RlcmVkRnVuY3Rpb25zQnlIYXNoOiBhbnk7XG5cblx0Y29uc3RydWN0b3IgKHBhcmVudENvbnRleHQ6IENvbnRleHQpIHtcblx0XHR0aGlzLnBhcmVudENvbnRleHQgPSBwYXJlbnRDb250ZXh0O1xuXG5cdFx0dGhpcy5fc2NvcGVEZXB0aCA9IDA7XG5cdFx0dGhpcy5fc2NvcGVDb3VudCA9IDA7XG5cblx0XHR0aGlzLl9yZWdpc3RlcmVkTmFtZXNwYWNlVVJJQnlQcmVmaXggPSBbT2JqZWN0LmNyZWF0ZShudWxsKV07XG5cdFx0dGhpcy5fcmVnaXN0ZXJlZFZhcmlhYmxlQmluZGluZ0J5SGFzaEtleSA9IFtPYmplY3QuY3JlYXRlKG51bGwpXTtcblxuXHRcdC8vIEZ1bmN0aW9ucyBtYXkgbmV2ZXIgYmUgYWRkZWQgZm9yIG9ubHkgYSBjbG9zdXJlXG5cdFx0dGhpcy5fcmVnaXN0ZXJlZEZ1bmN0aW9uc0J5SGFzaCA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cdH1cblxuXHRyZWdpc3RlckZ1bmN0aW9uRGVmaW5pdGlvbiAobmFtZXNwYWNlVVJJLCBsb2NhbE5hbWUsIGFyaXR5LCBmdW5jdGlvbkRlZmluaXRpb24pIHtcblx0XHRjb25zdCBoYXNoS2V5ID0gY3JlYXRlSGFzaEtleShuYW1lc3BhY2VVUkksIGxvY2FsTmFtZSkgKyAnficgKyBhcml0eTtcblx0XHRjb25zdCBkdXBsaWNhdGVGdW5jdGlvbiA9IHRoaXMuX3JlZ2lzdGVyZWRGdW5jdGlvbnNCeUhhc2hbaGFzaEtleV07XG5cdFx0aWYgKGR1cGxpY2F0ZUZ1bmN0aW9uKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ0R1cGxpY2F0ZSBmdW5jdGlvbiByZWdpc3RyYXRpb24nKTtcblx0XHR9XG5cblx0XHR0aGlzLl9yZWdpc3RlcmVkRnVuY3Rpb25zQnlIYXNoW2hhc2hLZXldID0gZnVuY3Rpb25EZWZpbml0aW9uO1xuXHR9XG5cblx0bG9va3VwRnVuY3Rpb24gKG5hbWVzcGFjZVVSSSwgbG9jYWxOYW1lLCBhcml0eSkge1xuXHRcdGNvbnN0IGhhc2hLZXkgPSBjcmVhdGVIYXNoS2V5KG5hbWVzcGFjZVVSSSwgbG9jYWxOYW1lKSArICd+JyArIGFyaXR5O1xuXHRcdGNvbnN0IGZvdW5kRnVuY3Rpb24gPSB0aGlzLl9yZWdpc3RlcmVkRnVuY3Rpb25zQnlIYXNoW2hhc2hLZXldO1xuXHRcdGlmIChmb3VuZEZ1bmN0aW9uKSB7XG5cdFx0XHRyZXR1cm4gZm91bmRGdW5jdGlvbjtcblx0XHR9XG5cblx0XHRyZXR1cm4gdGhpcy5wYXJlbnRDb250ZXh0ID09PSBudWxsID8gbnVsbCA6IHRoaXMucGFyZW50Q29udGV4dC5sb29rdXBGdW5jdGlvbihcblx0XHRcdG5hbWVzcGFjZVVSSSxcblx0XHRcdGxvY2FsTmFtZSxcblx0XHRcdGFyaXR5KTtcblx0fVxuXG5cdC8qKlxuXHQgKiBSZWdpc3RlciB0aGUgX2V4aXN0ZW5jZV8gb2YgYSB2YXJpYWJsZS5cblx0ICpcblx0ICogV2UgbmVlZCB0aGlzIHRvIHNlcGFyYXRlIHZhcmlhYmxlIGRlY2xhcmF0aW9uICh3aGljaCBpcyByZXF1aXJlZCB0byBiZSBkb25lIHN0YXRpY2FsbHkpIGFuZFxuXHQgKiBmcm9tIHdoZW4gdGhlIGR5bmFtaWMgY29udGV4dCBvZiB0aGUgdmFyaWFibGUgd2lsbCBiZSBrbm93bi5cblx0ICovXG5cdHJlZ2lzdGVyVmFyaWFibGUgKG5hbWVzcGFjZVVSSSwgbG9jYWxOYW1lKSB7XG5cdFx0Y29uc3QgaGFzaCA9IGNyZWF0ZUhhc2hLZXkobmFtZXNwYWNlVVJJLCBsb2NhbE5hbWUpO1xuXHRcdHJldHVybiB0aGlzLl9yZWdpc3RlcmVkVmFyaWFibGVCaW5kaW5nQnlIYXNoS2V5W3RoaXMuX3Njb3BlRGVwdGhdW2hhc2hdID0gYCR7aGFzaH1bJHt0aGlzLl9zY29wZUNvdW50fV1gO1xuXHR9XG5cblx0cmVnaXN0ZXJOYW1lc3BhY2UgKHByZWZpeCwgbmFtZXNwYWNlVVJJKSB7XG5cdFx0dGhpcy5fcmVnaXN0ZXJlZE5hbWVzcGFjZVVSSUJ5UHJlZml4W3RoaXMuX3Njb3BlRGVwdGhdW3ByZWZpeF0gPSBuYW1lc3BhY2VVUkk7XG5cdH1cblxuXHRsb29rdXBWYXJpYWJsZSAobmFtZXNwYWNlVVJJLCBsb2NhbE5hbWUpIHtcblx0XHRjb25zdCBoYXNoID0gY3JlYXRlSGFzaEtleShuYW1lc3BhY2VVUkksIGxvY2FsTmFtZSk7XG5cdFx0Y29uc3QgdmFyTmFtZUluQ3VycmVudFNjb3BlID0gbG9va3VwSW5PdmVycmlkZXModGhpcy5fcmVnaXN0ZXJlZFZhcmlhYmxlQmluZGluZ0J5SGFzaEtleSwgaGFzaCk7XG5cdFx0aWYgKHZhck5hbWVJbkN1cnJlbnRTY29wZSkge1xuXHRcdFx0cmV0dXJuIHZhck5hbWVJbkN1cnJlbnRTY29wZTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXMucGFyZW50Q29udGV4dC5sb29rdXBWYXJpYWJsZShuYW1lc3BhY2VVUkksIGxvY2FsTmFtZSk7XG5cdH1cblxuXHRpbnRyb2R1Y2VTY29wZSAoKSB7XG5cdFx0dGhpcy5fc2NvcGVDb3VudCsrO1xuXHRcdHRoaXMuX3Njb3BlRGVwdGgrKztcblxuXHRcdHRoaXMuX3JlZ2lzdGVyZWROYW1lc3BhY2VVUklCeVByZWZpeFt0aGlzLl9zY29wZURlcHRoXSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cdFx0dGhpcy5fcmVnaXN0ZXJlZFZhcmlhYmxlQmluZGluZ0J5SGFzaEtleVt0aGlzLl9zY29wZURlcHRoXSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG5cdH1cblxuXHRyZW1vdmVTY29wZSAoKSB7XG5cdFx0dGhpcy5fcmVnaXN0ZXJlZE5hbWVzcGFjZVVSSUJ5UHJlZml4Lmxlbmd0aCA9IHRoaXMuX3Njb3BlRGVwdGg7XG5cdFx0dGhpcy5fcmVnaXN0ZXJlZFZhcmlhYmxlQmluZGluZ0J5SGFzaEtleS5sZW5ndGggPSB0aGlzLl9zY29wZURlcHRoO1xuXHRcdHRoaXMuX3Njb3BlRGVwdGgtLTtcblx0fVxuXG5cdHJlc29sdmVOYW1lc3BhY2UgKHByZWZpeCkge1xuXHRcdGNvbnN0IHVyaSA9IGxvb2t1cEluT3ZlcnJpZGVzKHRoaXMuX3JlZ2lzdGVyZWROYW1lc3BhY2VVUklCeVByZWZpeCwgcHJlZml4KTtcblx0XHRpZiAodXJpID09PSB1bmRlZmluZWQpIHtcblx0XHRcdHJldHVybiB0aGlzLnBhcmVudENvbnRleHQgPT09IG51bGwgPyB1bmRlZmluZWQgOiB0aGlzLnBhcmVudENvbnRleHQucmVzb2x2ZU5hbWVzcGFjZShwcmVmaXgpO1xuXHRcdH1cblx0XHRyZXR1cm4gdXJpO1xuXHR9XG5cblx0LyoqXG5cdCAqIE1ha2UgYSBjbG9uZSBvZiB0aGlzIHN0YXRpYyBjb250ZXh0IGF0IHRoZSBjdXJyZW50IHNjb3BlIHRoYXQgY2FuIGJlIHJldGFpbmVkIGZvciBsYXRlciB1c2FnZVxuXHQgKiAoc3VjaCBhcyBkeW5hbWljIG5hbWVzcGFjZSBsb29rdXBzKVxuXHQgKlxuXHQgKiBAcmV0dXJuIHtTdGF0aWNDb250ZXh0fVxuXHQgKi9cblx0Y2xvbmVDb250ZXh0ICgpIHtcblx0XHRjb25zdCBjb250ZXh0QXRUaGlzUG9pbnQgPSBuZXcgU3RhdGljQ29udGV4dCh0aGlzLnBhcmVudENvbnRleHQpO1xuXHRcdGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5fc2NvcGVEZXB0aCArIDE7ICsraSkge1xuXHRcdFx0Y29udGV4dEF0VGhpc1BvaW50Ll9yZWdpc3RlcmVkTmFtZXNwYWNlVVJJQnlQcmVmaXggPSBbT2JqZWN0LmFzc2lnbihcblx0XHRcdFx0T2JqZWN0LmNyZWF0ZShudWxsKSxcblx0XHRcdFx0Y29udGV4dEF0VGhpc1BvaW50Ll9yZWdpc3RlcmVkTmFtZXNwYWNlVVJJQnlQcmVmaXhbMF0sXG5cdFx0XHRcdHRoaXMuX3JlZ2lzdGVyZWROYW1lc3BhY2VVUklCeVByZWZpeFtpXSldO1xuXHRcdFx0Y29udGV4dEF0VGhpc1BvaW50Ll9yZWdpc3RlcmVkVmFyaWFibGVCaW5kaW5nQnlIYXNoS2V5ID0gW09iamVjdC5hc3NpZ24oXG5cdFx0XHRcdE9iamVjdC5jcmVhdGUobnVsbCksXG5cdFx0XHRcdGNvbnRleHRBdFRoaXNQb2ludC5fcmVnaXN0ZXJlZFZhcmlhYmxlQmluZGluZ0J5SGFzaEtleVswXSxcblx0XHRcdFx0dGhpcy5fcmVnaXN0ZXJlZFZhcmlhYmxlQmluZGluZ0J5SGFzaEtleVtpXSldO1xuXHRcdH1cblxuXHRcdHJldHVybiBjb250ZXh0QXRUaGlzUG9pbnQ7XG5cdH1cbn1cbiJdfQ==