"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const castToType_1 = require("../../dataTypes/castToType");
const isSubtypeOf_1 = require("../../dataTypes/isSubtypeOf");
const DateTime_1 = require("../../dataTypes/valueTypes/DateTime");
const YearMonthDuration_1 = require("../../dataTypes/valueTypes/YearMonthDuration");
const DayTimeDuration_1 = require("../../dataTypes/valueTypes/DayTimeDuration");
// Use partial application to get to a comparer faster
function areBothStringOrAnyURI(a, b) {
    return (isSubtypeOf_1.default(a, 'xs:string') || isSubtypeOf_1.default(a, 'xs:anyURI')) &&
        (isSubtypeOf_1.default(b, 'xs:string') || isSubtypeOf_1.default(b, 'xs:anyURI'));
}
function generateCompareFunction(operator, typeA, typeB, dynamicContext) {
    let castFunctionForValueA = null;
    let castFunctionForValueB = null;
    if (isSubtypeOf_1.default(typeA, 'xs:untypedAtomic') && isSubtypeOf_1.default(typeB, 'xs:untypedAtomic')) {
        typeA = typeB = 'xs:string';
    }
    else if (isSubtypeOf_1.default(typeA, 'xs:untypedAtomic')) {
        castFunctionForValueA = val => castToType_1.default(val, typeB);
        typeA = typeB;
    }
    else if (isSubtypeOf_1.default(typeB, 'xs:untypedAtomic')) {
        castFunctionForValueB = val => castToType_1.default(val, typeA);
        typeB = typeA;
    }
    function applyCastFunctions(valA, valB) {
        return {
            castA: castFunctionForValueA ? castFunctionForValueA(valA) : valA,
            castB: castFunctionForValueB ? castFunctionForValueB(valB) : valB
        };
    }
    if (isSubtypeOf_1.default(typeA, 'xs:QName') && isSubtypeOf_1.default(typeB, 'xs:QName')) {
        if (operator === 'eqOp') {
            return (a, b) => {
                const { castA, castB } = applyCastFunctions(a, b);
                return castA.value.namespaceURI === castB.value.namespaceURI && castA.value.localPart === castB.value.localPart;
            };
        }
        if (operator === 'neOp') {
            return (a, b) => {
                const { castA, castB } = applyCastFunctions(a, b);
                return castA.value.namespaceURI !== castB.value.namespaceURI || castA.value.localPart !== castB.value.localPart;
            };
        }
        throw new Error('XPTY0004: Only the "eq" and "ne" comparison is defined for xs:QName');
    }
    function areBothSubtypeOf(type) {
        return isSubtypeOf_1.default(typeA, type) && isSubtypeOf_1.default(typeB, type);
    }
    if (areBothSubtypeOf('xs:boolean') ||
        areBothSubtypeOf('xs:string') ||
        areBothSubtypeOf('xs:numeric') ||
        areBothSubtypeOf('xs:anyURI') ||
        areBothSubtypeOf('xs:hexBinary') ||
        areBothSubtypeOf('xs:base64Binary') ||
        areBothStringOrAnyURI(typeA, typeB)) {
        switch (operator) {
            case 'eqOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value === castB.value;
                };
            case 'neOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value !== castB.value;
                };
            case 'ltOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value < castB.value;
                };
            case 'leOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value <= castB.value;
                };
            case 'gtOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value > castB.value;
                };
            case 'geOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value >= castB.value;
                };
        }
    }
    if (areBothSubtypeOf('xs:dateTime') ||
        areBothSubtypeOf('xs:date') ||
        areBothSubtypeOf('xs:time')) {
        switch (operator) {
            case 'eqOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return DateTime_1.equal(castA.value, castB.value, dynamicContext.getImplicitTimezone());
                };
            case 'neOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return !DateTime_1.equal(castA.value, castB.value, dynamicContext.getImplicitTimezone());
                };
            case 'ltOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return DateTime_1.lessThan(castA.value, castB.value, dynamicContext.getImplicitTimezone());
                };
            case 'leOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return DateTime_1.equal(castA.value, castB.value, dynamicContext.getImplicitTimezone()) ||
                        DateTime_1.lessThan(castA.value, castB.value, dynamicContext.getImplicitTimezone());
                };
            case 'gtOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return DateTime_1.greaterThan(castA.value, castB.value, dynamicContext.getImplicitTimezone());
                };
            case 'geOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return DateTime_1.equal(castA.value, castB.value, dynamicContext.getImplicitTimezone()) ||
                        DateTime_1.greaterThan(castA.value, castB.value, dynamicContext.getImplicitTimezone());
                };
        }
    }
    if (areBothSubtypeOf('xs:gYearMonth') ||
        areBothSubtypeOf('xs:gYear') ||
        areBothSubtypeOf('xs:gMonthDay') ||
        areBothSubtypeOf('xs:gMonth') ||
        areBothSubtypeOf('xs:gDay')) {
        switch (operator) {
            case 'eqOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return DateTime_1.equal(castA.value, castB.value, dynamicContext.getImplicitTimezone());
                };
            case 'neOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return !DateTime_1.equal(castA.value, castB.value, dynamicContext.getImplicitTimezone());
                };
        }
    }
    if (areBothSubtypeOf('xs:yearMonthDuration')) {
        switch (operator) {
            case 'ltOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return YearMonthDuration_1.lessThan(castA.value, castB.value);
                };
            case 'leOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value.equals(castB.value) ||
                        YearMonthDuration_1.lessThan(castA.value, castB.value);
                };
            case 'gtOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return YearMonthDuration_1.greaterThan(castA.value, castB.value);
                };
            case 'geOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value.equals(castB.value) ||
                        YearMonthDuration_1.greaterThan(castA.value, castB.value);
                };
        }
    }
    if (areBothSubtypeOf('xs:dayTimeDuration')) {
        switch (operator) {
            case 'eqOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value.equals(castB.value);
                };
            case 'ltOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return DayTimeDuration_1.lessThan(castA.value, castB.value);
                };
            case 'leOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value.equals(castB.value) ||
                        DayTimeDuration_1.lessThan(castA.value, castB.value);
                };
            case 'gtOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return DayTimeDuration_1.greaterThan(castA.value, castB.value);
                };
            case 'geOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value.equals(castB.value) ||
                        DayTimeDuration_1.greaterThan(castA.value, castB.value);
                };
        }
    }
    if (areBothSubtypeOf('xs:duration')) {
        switch (operator) {
            case 'eqOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return castA.value.equals(castB.value);
                };
            case 'neOp':
                return (a, b) => {
                    const { castA, castB } = applyCastFunctions(a, b);
                    return !castA.value.equals(castB.value);
                };
        }
    }
    throw new Error(`XPTY0004: ${operator} not available for ${typeA} and ${typeB}`);
}
const comparatorsByTypingKey = Object.create(null);
function valueCompare(operator, valueA, valueB, dynamicContext) {
    // https://www.w3.org/TR/xpath-3/#doc-xpath31-ValueComp
    const typingKey = `${valueA.type}~${valueB.type}~${operator}`;
    let prefabComparator = comparatorsByTypingKey[typingKey];
    if (!prefabComparator) {
        prefabComparator = comparatorsByTypingKey[typingKey] = generateCompareFunction(operator, valueA.type, valueB.type, dynamicContext);
    }
    return prefabComparator(valueA, valueB);
}
exports.default = valueCompare;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsdWVDb21wYXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidmFsdWVDb21wYXJlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkRBQW9EO0FBQ3BELDZEQUFzRDtBQUV0RCxrRUFJNkM7QUFDN0Msb0ZBR3NEO0FBQ3RELGdGQUdvRDtBQUtwRCxzREFBc0Q7QUFDdEQsU0FBUyxxQkFBcUIsQ0FBRSxDQUFDLEVBQUUsQ0FBQztJQUNuQyxPQUFPLENBQUMscUJBQVcsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLElBQUkscUJBQVcsQ0FBQyxDQUFDLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDbEUsQ0FBQyxxQkFBVyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsSUFBSSxxQkFBVyxDQUFDLENBQUMsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDO0FBQy9ELENBQUM7QUFFRCxTQUFTLHVCQUF1QixDQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLGNBQWM7SUFDdkUsSUFBSSxxQkFBcUIsR0FBRyxJQUFJLENBQUM7SUFDakMsSUFBSSxxQkFBcUIsR0FBRyxJQUFJLENBQUM7SUFFakMsSUFBSSxxQkFBVyxDQUFDLEtBQUssRUFBRSxrQkFBa0IsQ0FBQyxJQUFJLHFCQUFXLENBQUMsS0FBSyxFQUFFLGtCQUFrQixDQUFDLEVBQUU7UUFDckYsS0FBSyxHQUFHLEtBQUssR0FBRyxXQUFXLENBQUM7S0FDNUI7U0FDSSxJQUFJLHFCQUFXLENBQUMsS0FBSyxFQUFFLGtCQUFrQixDQUFDLEVBQUU7UUFDaEQscUJBQXFCLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQyxvQkFBVSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN0RCxLQUFLLEdBQUcsS0FBSyxDQUFDO0tBQ2Q7U0FDSSxJQUFJLHFCQUFXLENBQUMsS0FBSyxFQUFFLGtCQUFrQixDQUFDLEVBQUU7UUFDaEQscUJBQXFCLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQyxvQkFBVSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUN0RCxLQUFLLEdBQUcsS0FBSyxDQUFDO0tBQ2Q7SUFFRCxTQUFTLGtCQUFrQixDQUFFLElBQUksRUFBRSxJQUFJO1FBQ3RDLE9BQU87WUFDTixLQUFLLEVBQUUscUJBQXFCLENBQUMsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJO1lBQ2pFLEtBQUssRUFBRSxxQkFBcUIsQ0FBQyxDQUFDLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUk7U0FDakUsQ0FBQztJQUNILENBQUM7SUFFRCxJQUFJLHFCQUFXLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxJQUFJLHFCQUFXLENBQUMsS0FBSyxFQUFFLFVBQVUsQ0FBQyxFQUFFO1FBQ3JFLElBQUksUUFBUSxLQUFLLE1BQU0sRUFBRTtZQUN4QixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUNsRCxPQUFPLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxLQUFLLEtBQUssQ0FBQyxLQUFLLENBQUMsWUFBWSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxLQUFLLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDO1lBQ2pILENBQUMsQ0FBQztTQUNGO1FBQ0QsSUFBSSxRQUFRLEtBQUssTUFBTSxFQUFFO1lBQ3hCLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ2YsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xELE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FBQyxZQUFZLEtBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxZQUFZLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFTLEtBQUssS0FBSyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUM7WUFDakgsQ0FBQyxDQUFDO1NBQ0Y7UUFDRCxNQUFNLElBQUksS0FBSyxDQUFDLHFFQUFxRSxDQUFDLENBQUM7S0FDdkY7SUFFRCxTQUFTLGdCQUFnQixDQUFFLElBQUk7UUFDOUIsT0FBTyxxQkFBVyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsSUFBSSxxQkFBVyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQsSUFBSSxnQkFBZ0IsQ0FBQyxZQUFZLENBQUM7UUFDakMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDO1FBQzdCLGdCQUFnQixDQUFDLFlBQVksQ0FBQztRQUM5QixnQkFBZ0IsQ0FBQyxXQUFXLENBQUM7UUFDN0IsZ0JBQWdCLENBQUMsY0FBYyxDQUFDO1FBQ2hDLGdCQUFnQixDQUFDLGlCQUFpQixDQUFDO1FBQ25DLHFCQUFxQixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsRUFBRTtRQUNyQyxRQUFRLFFBQVEsRUFBRTtZQUNqQixLQUFLLE1BQU07Z0JBQ1YsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDZixNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLGtCQUFrQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDbEQsT0FBTyxLQUFLLENBQUMsS0FBSyxLQUFLLEtBQUssQ0FBQyxLQUFLLENBQUM7Z0JBQ3BDLENBQUMsQ0FBQztZQUNILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLEtBQUssQ0FBQyxLQUFLLEtBQUssS0FBSyxDQUFDLEtBQUssQ0FBQztnQkFDcEMsQ0FBQyxDQUFDO1lBQ0gsS0FBSyxNQUFNO2dCQUNWLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ2YsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ2xELE9BQU8sS0FBSyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO2dCQUNsQyxDQUFDLENBQUM7WUFDSCxLQUFLLE1BQU07Z0JBQ1YsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDZixNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLGtCQUFrQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDbEQsT0FBTyxLQUFLLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUM7Z0JBQ25DLENBQUMsQ0FBQztZQUNILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztnQkFDbEMsQ0FBQyxDQUFDO1lBQ0gsS0FBSyxNQUFNO2dCQUNWLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ2YsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ2xELE9BQU8sS0FBSyxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDO2dCQUNuQyxDQUFDLENBQUM7U0FDSDtLQUNEO0lBRUQsSUFBSSxnQkFBZ0IsQ0FBQyxhQUFhLENBQUM7UUFDbEMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDO1FBQzNCLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxFQUFFO1FBQzdCLFFBQVEsUUFBUSxFQUFFO1lBQ2pCLEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLGdCQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUM7Z0JBQ3RGLENBQUMsQ0FBQztZQUNILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLENBQUMsZ0JBQWEsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztnQkFDdkYsQ0FBQyxDQUFDO1lBRUgsS0FBSyxNQUFNO2dCQUNWLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ2YsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ2xELE9BQU8sbUJBQWdCLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUM7Z0JBQ3pGLENBQUMsQ0FBQztZQUNILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLGdCQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO3dCQUNuRixtQkFBZ0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztnQkFDbkYsQ0FBQyxDQUFDO1lBRUgsS0FBSyxNQUFNO2dCQUNWLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ2YsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ2xELE9BQU8sc0JBQW1CLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUM7Z0JBQzVGLENBQUMsQ0FBQztZQUNILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLGdCQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO3dCQUNuRixzQkFBbUIsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztnQkFDdEYsQ0FBQyxDQUFDO1NBQ0g7S0FDRDtJQUVELElBQUksZ0JBQWdCLENBQUMsZUFBZSxDQUFDO1FBQ3BDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQztRQUM1QixnQkFBZ0IsQ0FBQyxjQUFjLENBQUM7UUFDaEMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDO1FBQzdCLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxFQUFFO1FBQzdCLFFBQVEsUUFBUSxFQUFFO1lBQ2pCLEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLGdCQUFhLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLGNBQWMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUM7Z0JBQ3RGLENBQUMsQ0FBQztZQUNILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLENBQUMsZ0JBQWEsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLEVBQUUsY0FBYyxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztnQkFDdkYsQ0FBQyxDQUFDO1NBQ0g7S0FDRDtJQUVELElBQUksZ0JBQWdCLENBQUMsc0JBQXNCLENBQUMsRUFBRTtRQUM3QyxRQUFRLFFBQVEsRUFBRTtZQUNqQixLQUFLLE1BQU07Z0JBQ1YsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDZixNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLGtCQUFrQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDbEQsT0FBTyw0QkFBeUIsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDNUQsQ0FBQyxDQUFDO1lBQ0gsS0FBSyxNQUFNO2dCQUNWLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ2YsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ2xELE9BQU8sS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQzt3QkFDckMsNEJBQXlCLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3RELENBQUMsQ0FBQztZQUVILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLCtCQUE0QixDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUMvRCxDQUFDLENBQUM7WUFDSCxLQUFLLE1BQU07Z0JBQ1YsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDZixNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLGtCQUFrQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDbEQsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDO3dCQUNyQywrQkFBNEIsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDekQsQ0FBQyxDQUFDO1NBQ0g7S0FDRDtJQUVELElBQUksZ0JBQWdCLENBQUMsb0JBQW9CLENBQUMsRUFBRTtRQUMzQyxRQUFRLFFBQVEsRUFBRTtZQUNqQixLQUFLLE1BQU07Z0JBQ1YsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDZixNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLGtCQUFrQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDbEQsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3hDLENBQUMsQ0FBQztZQUNILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLDBCQUF1QixDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUMxRCxDQUFDLENBQUM7WUFDSCxLQUFLLE1BQU07Z0JBQ1YsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDZixNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLGtCQUFrQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDbEQsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDO3dCQUNyQywwQkFBdUIsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDcEQsQ0FBQyxDQUFDO1lBQ0gsS0FBSyxNQUFNO2dCQUNWLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7b0JBQ2YsTUFBTSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsR0FBRyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7b0JBQ2xELE9BQU8sNkJBQTBCLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzdELENBQUMsQ0FBQztZQUNILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7d0JBQ3JDLDZCQUEwQixDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN2RCxDQUFDLENBQUM7U0FDSDtLQUNEO0lBRUQsSUFBSSxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsRUFBRTtRQUNwQyxRQUFRLFFBQVEsRUFBRTtZQUNqQixLQUFLLE1BQU07Z0JBQ1YsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtvQkFDZixNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxHQUFHLGtCQUFrQixDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztvQkFDbEQsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3hDLENBQUMsQ0FBQztZQUNILEtBQUssTUFBTTtnQkFDVixPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO29CQUNmLE1BQU0sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEdBQUcsa0JBQWtCLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUNsRCxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN6QyxDQUFDLENBQUM7U0FDSDtLQUNEO0lBRUQsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLFFBQVEsc0JBQXNCLEtBQUssUUFBUSxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBQ2xGLENBQUM7QUFFRCxNQUFNLHNCQUFzQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7QUFFbkQsU0FBd0IsWUFBWSxDQUFDLFFBQWdCLEVBQUUsTUFBbUIsRUFBRSxNQUFtQixFQUFFLGNBQThCO0lBQzlILHVEQUF1RDtJQUN2RCxNQUFNLFNBQVMsR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLElBQUksTUFBTSxDQUFDLElBQUksSUFBSSxRQUFRLEVBQUUsQ0FBQztJQUM5RCxJQUFJLGdCQUFnQixHQUFHLHNCQUFzQixDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3pELElBQUksQ0FBQyxnQkFBZ0IsRUFBRTtRQUN0QixnQkFBZ0IsR0FBRyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsR0FBRyx1QkFBdUIsQ0FBQyxRQUFRLEVBQUUsTUFBTSxDQUFDLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0tBQ25JO0lBRUQsT0FBTyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDekMsQ0FBQztBQVRELCtCQVNDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNhc3RUb1R5cGUgZnJvbSAnLi4vLi4vZGF0YVR5cGVzL2Nhc3RUb1R5cGUnO1xuaW1wb3J0IGlzU3VidHlwZU9mIGZyb20gJy4uLy4uL2RhdGFUeXBlcy9pc1N1YnR5cGVPZic7XG5cbmltcG9ydCB7XG5cdGVxdWFsIGFzIGRhdGVUaW1lRXF1YWwsXG5cdGxlc3NUaGFuIGFzIGRhdGVUaW1lTGVzc1RoYW4sXG5cdGdyZWF0ZXJUaGFuIGFzIGRhdGVUaW1lR3JlYXRlclRoYW5cbn0gZnJvbSAnLi4vLi4vZGF0YVR5cGVzL3ZhbHVlVHlwZXMvRGF0ZVRpbWUnO1xuaW1wb3J0IHtcblx0bGVzc1RoYW4gYXMgeWVhck1vbnRoRHVyYXRpb25MZXNzVGhhbixcblx0Z3JlYXRlclRoYW4gYXMgeWVhck1vbnRoRHVyYXRpb25HcmVhdGVyVGhhblxufSBmcm9tICcuLi8uLi9kYXRhVHlwZXMvdmFsdWVUeXBlcy9ZZWFyTW9udGhEdXJhdGlvbic7XG5pbXBvcnQge1xuXHRsZXNzVGhhbiBhcyBkYXlUaW1lRHVyYXRpb25MZXNzVGhhbixcblx0Z3JlYXRlclRoYW4gYXMgZGF5VGltZUR1cmF0aW9uR3JlYXRlclRoYW5cbn0gZnJvbSAnLi4vLi4vZGF0YVR5cGVzL3ZhbHVlVHlwZXMvRGF5VGltZUR1cmF0aW9uJztcblxuaW1wb3J0IER5bmFtaWNDb250ZXh0IGZyb20gJy4uLy4uL0R5bmFtaWNDb250ZXh0JztcbmltcG9ydCBBdG9taWNWYWx1ZSBmcm9tICcuLi8uLi9kYXRhVHlwZXMvQXRvbWljVmFsdWUnO1xuXG4vLyBVc2UgcGFydGlhbCBhcHBsaWNhdGlvbiB0byBnZXQgdG8gYSBjb21wYXJlciBmYXN0ZXJcbmZ1bmN0aW9uIGFyZUJvdGhTdHJpbmdPckFueVVSSSAoYSwgYikge1xuXHRyZXR1cm4gKGlzU3VidHlwZU9mKGEsICd4czpzdHJpbmcnKSB8fCBpc1N1YnR5cGVPZihhLCAneHM6YW55VVJJJykpICYmXG5cdFx0KGlzU3VidHlwZU9mKGIsICd4czpzdHJpbmcnKSB8fCBpc1N1YnR5cGVPZihiLCAneHM6YW55VVJJJykpO1xufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZUNvbXBhcmVGdW5jdGlvbiAob3BlcmF0b3IsIHR5cGVBLCB0eXBlQiwgZHluYW1pY0NvbnRleHQpIHtcblx0bGV0IGNhc3RGdW5jdGlvbkZvclZhbHVlQSA9IG51bGw7XG5cdGxldCBjYXN0RnVuY3Rpb25Gb3JWYWx1ZUIgPSBudWxsO1xuXG5cdGlmIChpc1N1YnR5cGVPZih0eXBlQSwgJ3hzOnVudHlwZWRBdG9taWMnKSAmJiBpc1N1YnR5cGVPZih0eXBlQiwgJ3hzOnVudHlwZWRBdG9taWMnKSkge1xuXHRcdHR5cGVBID0gdHlwZUIgPSAneHM6c3RyaW5nJztcblx0fVxuXHRlbHNlIGlmIChpc1N1YnR5cGVPZih0eXBlQSwgJ3hzOnVudHlwZWRBdG9taWMnKSkge1xuXHRcdGNhc3RGdW5jdGlvbkZvclZhbHVlQSA9IHZhbCA9PiBjYXN0VG9UeXBlKHZhbCwgdHlwZUIpO1xuXHRcdHR5cGVBID0gdHlwZUI7XG5cdH1cblx0ZWxzZSBpZiAoaXNTdWJ0eXBlT2YodHlwZUIsICd4czp1bnR5cGVkQXRvbWljJykpIHtcblx0XHRjYXN0RnVuY3Rpb25Gb3JWYWx1ZUIgPSB2YWwgPT4gY2FzdFRvVHlwZSh2YWwsIHR5cGVBKTtcblx0XHR0eXBlQiA9IHR5cGVBO1xuXHR9XG5cblx0ZnVuY3Rpb24gYXBwbHlDYXN0RnVuY3Rpb25zICh2YWxBLCB2YWxCKSB7XG5cdFx0cmV0dXJuIHtcblx0XHRcdGNhc3RBOiBjYXN0RnVuY3Rpb25Gb3JWYWx1ZUEgPyBjYXN0RnVuY3Rpb25Gb3JWYWx1ZUEodmFsQSkgOiB2YWxBLFxuXHRcdFx0Y2FzdEI6IGNhc3RGdW5jdGlvbkZvclZhbHVlQiA/IGNhc3RGdW5jdGlvbkZvclZhbHVlQih2YWxCKSA6IHZhbEJcblx0XHR9O1xuXHR9XG5cblx0aWYgKGlzU3VidHlwZU9mKHR5cGVBLCAneHM6UU5hbWUnKSAmJiBpc1N1YnR5cGVPZih0eXBlQiwgJ3hzOlFOYW1lJykpIHtcblx0XHRpZiAob3BlcmF0b3IgPT09ICdlcU9wJykge1xuXHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHsgY2FzdEEsIGNhc3RCIH0gPSBhcHBseUNhc3RGdW5jdGlvbnMoYSwgYik7XG5cdFx0XHRcdHJldHVybiBjYXN0QS52YWx1ZS5uYW1lc3BhY2VVUkkgPT09IGNhc3RCLnZhbHVlLm5hbWVzcGFjZVVSSSAmJiBjYXN0QS52YWx1ZS5sb2NhbFBhcnQgPT09IGNhc3RCLnZhbHVlLmxvY2FsUGFydDtcblx0XHRcdH07XG5cdFx0fVxuXHRcdGlmIChvcGVyYXRvciA9PT0gJ25lT3AnKSB7XG5cdFx0XHRyZXR1cm4gKGEsIGIpID0+IHtcblx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0cmV0dXJuIGNhc3RBLnZhbHVlLm5hbWVzcGFjZVVSSSAhPT0gY2FzdEIudmFsdWUubmFtZXNwYWNlVVJJIHx8IGNhc3RBLnZhbHVlLmxvY2FsUGFydCAhPT0gY2FzdEIudmFsdWUubG9jYWxQYXJ0O1xuXHRcdFx0fTtcblx0XHR9XG5cdFx0dGhyb3cgbmV3IEVycm9yKCdYUFRZMDAwNDogT25seSB0aGUgXCJlcVwiIGFuZCBcIm5lXCIgY29tcGFyaXNvbiBpcyBkZWZpbmVkIGZvciB4czpRTmFtZScpO1xuXHR9XG5cblx0ZnVuY3Rpb24gYXJlQm90aFN1YnR5cGVPZiAodHlwZSkge1xuXHRcdHJldHVybiBpc1N1YnR5cGVPZih0eXBlQSwgdHlwZSkgJiYgaXNTdWJ0eXBlT2YodHlwZUIsIHR5cGUpO1xuXHR9XG5cblx0aWYgKGFyZUJvdGhTdWJ0eXBlT2YoJ3hzOmJvb2xlYW4nKSB8fFxuXHRcdGFyZUJvdGhTdWJ0eXBlT2YoJ3hzOnN0cmluZycpIHx8XG5cdFx0YXJlQm90aFN1YnR5cGVPZigneHM6bnVtZXJpYycpIHx8XG5cdFx0YXJlQm90aFN1YnR5cGVPZigneHM6YW55VVJJJykgfHxcblx0XHRhcmVCb3RoU3VidHlwZU9mKCd4czpoZXhCaW5hcnknKSB8fFxuXHRcdGFyZUJvdGhTdWJ0eXBlT2YoJ3hzOmJhc2U2NEJpbmFyeScpIHx8XG5cdFx0YXJlQm90aFN0cmluZ09yQW55VVJJKHR5cGVBLCB0eXBlQikpIHtcblx0XHRzd2l0Y2ggKG9wZXJhdG9yKSB7XG5cdFx0XHRjYXNlICdlcU9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gY2FzdEEudmFsdWUgPT09IGNhc3RCLnZhbHVlO1xuXHRcdFx0XHR9O1xuXHRcdFx0Y2FzZSAnbmVPcCc6XG5cdFx0XHRcdHJldHVybiAoYSwgYikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHsgY2FzdEEsIGNhc3RCIH0gPSBhcHBseUNhc3RGdW5jdGlvbnMoYSwgYik7XG5cdFx0XHRcdFx0cmV0dXJuIGNhc3RBLnZhbHVlICE9PSBjYXN0Qi52YWx1ZTtcblx0XHRcdFx0fTtcblx0XHRcdGNhc2UgJ2x0T3AnOlxuXHRcdFx0XHRyZXR1cm4gKGEsIGIpID0+IHtcblx0XHRcdFx0XHRjb25zdCB7IGNhc3RBLCBjYXN0QiB9ID0gYXBwbHlDYXN0RnVuY3Rpb25zKGEsIGIpO1xuXHRcdFx0XHRcdHJldHVybiBjYXN0QS52YWx1ZSA8IGNhc3RCLnZhbHVlO1xuXHRcdFx0XHR9O1xuXHRcdFx0Y2FzZSAnbGVPcCc6XG5cdFx0XHRcdHJldHVybiAoYSwgYikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHsgY2FzdEEsIGNhc3RCIH0gPSBhcHBseUNhc3RGdW5jdGlvbnMoYSwgYik7XG5cdFx0XHRcdFx0cmV0dXJuIGNhc3RBLnZhbHVlIDw9IGNhc3RCLnZhbHVlO1xuXHRcdFx0XHR9O1xuXHRcdFx0Y2FzZSAnZ3RPcCc6XG5cdFx0XHRcdHJldHVybiAoYSwgYikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHsgY2FzdEEsIGNhc3RCIH0gPSBhcHBseUNhc3RGdW5jdGlvbnMoYSwgYik7XG5cdFx0XHRcdFx0cmV0dXJuIGNhc3RBLnZhbHVlID4gY2FzdEIudmFsdWU7XG5cdFx0XHRcdH07XG5cdFx0XHRjYXNlICdnZU9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gY2FzdEEudmFsdWUgPj0gY2FzdEIudmFsdWU7XG5cdFx0XHRcdH07XG5cdFx0fVxuXHR9XG5cblx0aWYgKGFyZUJvdGhTdWJ0eXBlT2YoJ3hzOmRhdGVUaW1lJykgfHxcblx0XHRhcmVCb3RoU3VidHlwZU9mKCd4czpkYXRlJykgfHxcblx0XHRhcmVCb3RoU3VidHlwZU9mKCd4czp0aW1lJykpIHtcblx0XHRzd2l0Y2ggKG9wZXJhdG9yKSB7XG5cdFx0XHRjYXNlICdlcU9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gZGF0ZVRpbWVFcXVhbChjYXN0QS52YWx1ZSwgY2FzdEIudmFsdWUsIGR5bmFtaWNDb250ZXh0LmdldEltcGxpY2l0VGltZXpvbmUoKSk7XG5cdFx0XHRcdH07XG5cdFx0XHRjYXNlICduZU9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gIWRhdGVUaW1lRXF1YWwoY2FzdEEudmFsdWUsIGNhc3RCLnZhbHVlLCBkeW5hbWljQ29udGV4dC5nZXRJbXBsaWNpdFRpbWV6b25lKCkpO1xuXHRcdFx0XHR9O1xuXG5cdFx0XHRjYXNlICdsdE9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gZGF0ZVRpbWVMZXNzVGhhbihjYXN0QS52YWx1ZSwgY2FzdEIudmFsdWUsIGR5bmFtaWNDb250ZXh0LmdldEltcGxpY2l0VGltZXpvbmUoKSk7XG5cdFx0XHRcdH07XG5cdFx0XHRjYXNlICdsZU9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gZGF0ZVRpbWVFcXVhbChjYXN0QS52YWx1ZSwgY2FzdEIudmFsdWUsIGR5bmFtaWNDb250ZXh0LmdldEltcGxpY2l0VGltZXpvbmUoKSkgfHxcblx0XHRcdFx0XHRcdGRhdGVUaW1lTGVzc1RoYW4oY2FzdEEudmFsdWUsIGNhc3RCLnZhbHVlLCBkeW5hbWljQ29udGV4dC5nZXRJbXBsaWNpdFRpbWV6b25lKCkpO1xuXHRcdFx0XHR9O1xuXG5cdFx0XHRjYXNlICdndE9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gZGF0ZVRpbWVHcmVhdGVyVGhhbihjYXN0QS52YWx1ZSwgY2FzdEIudmFsdWUsIGR5bmFtaWNDb250ZXh0LmdldEltcGxpY2l0VGltZXpvbmUoKSk7XG5cdFx0XHRcdH07XG5cdFx0XHRjYXNlICdnZU9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gZGF0ZVRpbWVFcXVhbChjYXN0QS52YWx1ZSwgY2FzdEIudmFsdWUsIGR5bmFtaWNDb250ZXh0LmdldEltcGxpY2l0VGltZXpvbmUoKSkgfHxcblx0XHRcdFx0XHRcdGRhdGVUaW1lR3JlYXRlclRoYW4oY2FzdEEudmFsdWUsIGNhc3RCLnZhbHVlLCBkeW5hbWljQ29udGV4dC5nZXRJbXBsaWNpdFRpbWV6b25lKCkpO1xuXHRcdFx0XHR9O1xuXHRcdH1cblx0fVxuXG5cdGlmIChhcmVCb3RoU3VidHlwZU9mKCd4czpnWWVhck1vbnRoJykgfHxcblx0XHRhcmVCb3RoU3VidHlwZU9mKCd4czpnWWVhcicpIHx8XG5cdFx0YXJlQm90aFN1YnR5cGVPZigneHM6Z01vbnRoRGF5JykgfHxcblx0XHRhcmVCb3RoU3VidHlwZU9mKCd4czpnTW9udGgnKSB8fFxuXHRcdGFyZUJvdGhTdWJ0eXBlT2YoJ3hzOmdEYXknKSkge1xuXHRcdHN3aXRjaCAob3BlcmF0b3IpIHtcblx0XHRcdGNhc2UgJ2VxT3AnOlxuXHRcdFx0XHRyZXR1cm4gKGEsIGIpID0+IHtcblx0XHRcdFx0XHRjb25zdCB7IGNhc3RBLCBjYXN0QiB9ID0gYXBwbHlDYXN0RnVuY3Rpb25zKGEsIGIpO1xuXHRcdFx0XHRcdHJldHVybiBkYXRlVGltZUVxdWFsKGNhc3RBLnZhbHVlLCBjYXN0Qi52YWx1ZSwgZHluYW1pY0NvbnRleHQuZ2V0SW1wbGljaXRUaW1lem9uZSgpKTtcblx0XHRcdFx0fTtcblx0XHRcdGNhc2UgJ25lT3AnOlxuXHRcdFx0XHRyZXR1cm4gKGEsIGIpID0+IHtcblx0XHRcdFx0XHRjb25zdCB7IGNhc3RBLCBjYXN0QiB9ID0gYXBwbHlDYXN0RnVuY3Rpb25zKGEsIGIpO1xuXHRcdFx0XHRcdHJldHVybiAhZGF0ZVRpbWVFcXVhbChjYXN0QS52YWx1ZSwgY2FzdEIudmFsdWUsIGR5bmFtaWNDb250ZXh0LmdldEltcGxpY2l0VGltZXpvbmUoKSk7XG5cdFx0XHRcdH07XG5cdFx0fVxuXHR9XG5cblx0aWYgKGFyZUJvdGhTdWJ0eXBlT2YoJ3hzOnllYXJNb250aER1cmF0aW9uJykpIHtcblx0XHRzd2l0Y2ggKG9wZXJhdG9yKSB7XG5cdFx0XHRjYXNlICdsdE9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4geWVhck1vbnRoRHVyYXRpb25MZXNzVGhhbihjYXN0QS52YWx1ZSwgY2FzdEIudmFsdWUpO1xuXHRcdFx0XHR9O1xuXHRcdFx0Y2FzZSAnbGVPcCc6XG5cdFx0XHRcdHJldHVybiAoYSwgYikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHsgY2FzdEEsIGNhc3RCIH0gPSBhcHBseUNhc3RGdW5jdGlvbnMoYSwgYik7XG5cdFx0XHRcdFx0cmV0dXJuIGNhc3RBLnZhbHVlLmVxdWFscyhjYXN0Qi52YWx1ZSkgfHxcblx0XHRcdFx0XHRcdHllYXJNb250aER1cmF0aW9uTGVzc1RoYW4oY2FzdEEudmFsdWUsIGNhc3RCLnZhbHVlKTtcblx0XHRcdFx0fTtcblxuXHRcdFx0Y2FzZSAnZ3RPcCc6XG5cdFx0XHRcdHJldHVybiAoYSwgYikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHsgY2FzdEEsIGNhc3RCIH0gPSBhcHBseUNhc3RGdW5jdGlvbnMoYSwgYik7XG5cdFx0XHRcdFx0cmV0dXJuIHllYXJNb250aER1cmF0aW9uR3JlYXRlclRoYW4oY2FzdEEudmFsdWUsIGNhc3RCLnZhbHVlKTtcblx0XHRcdFx0fTtcblx0XHRcdGNhc2UgJ2dlT3AnOlxuXHRcdFx0XHRyZXR1cm4gKGEsIGIpID0+IHtcblx0XHRcdFx0XHRjb25zdCB7IGNhc3RBLCBjYXN0QiB9ID0gYXBwbHlDYXN0RnVuY3Rpb25zKGEsIGIpO1xuXHRcdFx0XHRcdHJldHVybiBjYXN0QS52YWx1ZS5lcXVhbHMoY2FzdEIudmFsdWUpIHx8XG5cdFx0XHRcdFx0XHR5ZWFyTW9udGhEdXJhdGlvbkdyZWF0ZXJUaGFuKGNhc3RBLnZhbHVlLCBjYXN0Qi52YWx1ZSk7XG5cdFx0XHRcdH07XG5cdFx0fVxuXHR9XG5cblx0aWYgKGFyZUJvdGhTdWJ0eXBlT2YoJ3hzOmRheVRpbWVEdXJhdGlvbicpKSB7XG5cdFx0c3dpdGNoIChvcGVyYXRvcikge1xuXHRcdFx0Y2FzZSAnZXFPcCc6XG5cdFx0XHRcdHJldHVybiAoYSwgYikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHsgY2FzdEEsIGNhc3RCIH0gPSBhcHBseUNhc3RGdW5jdGlvbnMoYSwgYik7XG5cdFx0XHRcdFx0cmV0dXJuIGNhc3RBLnZhbHVlLmVxdWFscyhjYXN0Qi52YWx1ZSk7XG5cdFx0XHRcdH07XG5cdFx0XHRjYXNlICdsdE9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gZGF5VGltZUR1cmF0aW9uTGVzc1RoYW4oY2FzdEEudmFsdWUsIGNhc3RCLnZhbHVlKTtcblx0XHRcdFx0fTtcblx0XHRcdGNhc2UgJ2xlT3AnOlxuXHRcdFx0XHRyZXR1cm4gKGEsIGIpID0+IHtcblx0XHRcdFx0XHRjb25zdCB7IGNhc3RBLCBjYXN0QiB9ID0gYXBwbHlDYXN0RnVuY3Rpb25zKGEsIGIpO1xuXHRcdFx0XHRcdHJldHVybiBjYXN0QS52YWx1ZS5lcXVhbHMoY2FzdEIudmFsdWUpIHx8XG5cdFx0XHRcdFx0XHRkYXlUaW1lRHVyYXRpb25MZXNzVGhhbihjYXN0QS52YWx1ZSwgY2FzdEIudmFsdWUpO1xuXHRcdFx0XHR9O1xuXHRcdFx0Y2FzZSAnZ3RPcCc6XG5cdFx0XHRcdHJldHVybiAoYSwgYikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHsgY2FzdEEsIGNhc3RCIH0gPSBhcHBseUNhc3RGdW5jdGlvbnMoYSwgYik7XG5cdFx0XHRcdFx0cmV0dXJuIGRheVRpbWVEdXJhdGlvbkdyZWF0ZXJUaGFuKGNhc3RBLnZhbHVlLCBjYXN0Qi52YWx1ZSk7XG5cdFx0XHRcdH07XG5cdFx0XHRjYXNlICdnZU9wJzpcblx0XHRcdFx0cmV0dXJuIChhLCBiKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgeyBjYXN0QSwgY2FzdEIgfSA9IGFwcGx5Q2FzdEZ1bmN0aW9ucyhhLCBiKTtcblx0XHRcdFx0XHRyZXR1cm4gY2FzdEEudmFsdWUuZXF1YWxzKGNhc3RCLnZhbHVlKSB8fFxuXHRcdFx0XHRcdFx0ZGF5VGltZUR1cmF0aW9uR3JlYXRlclRoYW4oY2FzdEEudmFsdWUsIGNhc3RCLnZhbHVlKTtcblx0XHRcdFx0fTtcblx0XHR9XG5cdH1cblxuXHRpZiAoYXJlQm90aFN1YnR5cGVPZigneHM6ZHVyYXRpb24nKSkge1xuXHRcdHN3aXRjaCAob3BlcmF0b3IpIHtcblx0XHRcdGNhc2UgJ2VxT3AnOlxuXHRcdFx0XHRyZXR1cm4gKGEsIGIpID0+IHtcblx0XHRcdFx0XHRjb25zdCB7IGNhc3RBLCBjYXN0QiB9ID0gYXBwbHlDYXN0RnVuY3Rpb25zKGEsIGIpO1xuXHRcdFx0XHRcdHJldHVybiBjYXN0QS52YWx1ZS5lcXVhbHMoY2FzdEIudmFsdWUpO1xuXHRcdFx0XHR9O1xuXHRcdFx0Y2FzZSAnbmVPcCc6XG5cdFx0XHRcdHJldHVybiAoYSwgYikgPT4ge1xuXHRcdFx0XHRcdGNvbnN0IHsgY2FzdEEsIGNhc3RCIH0gPSBhcHBseUNhc3RGdW5jdGlvbnMoYSwgYik7XG5cdFx0XHRcdFx0cmV0dXJuICFjYXN0QS52YWx1ZS5lcXVhbHMoY2FzdEIudmFsdWUpO1xuXHRcdFx0XHR9O1xuXHRcdH1cblx0fVxuXG5cdHRocm93IG5ldyBFcnJvcihgWFBUWTAwMDQ6ICR7b3BlcmF0b3J9IG5vdCBhdmFpbGFibGUgZm9yICR7dHlwZUF9IGFuZCAke3R5cGVCfWApO1xufVxuXG5jb25zdCBjb21wYXJhdG9yc0J5VHlwaW5nS2V5ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdmFsdWVDb21wYXJlKG9wZXJhdG9yOiBzdHJpbmcsIHZhbHVlQTogQXRvbWljVmFsdWUsIHZhbHVlQjogQXRvbWljVmFsdWUsIGR5bmFtaWNDb250ZXh0OiBEeW5hbWljQ29udGV4dCkge1xuXHQvLyBodHRwczovL3d3dy53My5vcmcvVFIveHBhdGgtMy8jZG9jLXhwYXRoMzEtVmFsdWVDb21wXG5cdGNvbnN0IHR5cGluZ0tleSA9IGAke3ZhbHVlQS50eXBlfX4ke3ZhbHVlQi50eXBlfX4ke29wZXJhdG9yfWA7XG5cdGxldCBwcmVmYWJDb21wYXJhdG9yID0gY29tcGFyYXRvcnNCeVR5cGluZ0tleVt0eXBpbmdLZXldO1xuXHRpZiAoIXByZWZhYkNvbXBhcmF0b3IpIHtcblx0XHRwcmVmYWJDb21wYXJhdG9yID0gY29tcGFyYXRvcnNCeVR5cGluZ0tleVt0eXBpbmdLZXldID0gZ2VuZXJhdGVDb21wYXJlRnVuY3Rpb24ob3BlcmF0b3IsIHZhbHVlQS50eXBlLCB2YWx1ZUIudHlwZSwgZHluYW1pY0NvbnRleHQpO1xuXHR9XG5cblx0cmV0dXJuIHByZWZhYkNvbXBhcmF0b3IodmFsdWVBLCB2YWx1ZUIpO1xufVxuIl19